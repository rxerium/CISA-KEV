name: CISA KEV

on:
  workflow_dispatch:
  schedule:
    - cron: '0 6,15 * * 1,2,3,4,5'  # KEV updates: Twice daily on weekdays
    - cron: '0 3 * * 0'              # PoC data: Weekly on Sunday at 3 AM UTC

jobs:
  CISA-KEV:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3

    - name: CISA KEV
      run: |
        mv data/raw/cisa-kev.csv data/raw/cisa-kev-old.csv
        curl --silent --output data/raw/cisa-kev.csv https://www.cisa.gov/sites/default/files/csv/known_exploited_vulnerabilities.csv
        echo "cisaOldVAR=$(data/raw/cisa-kev-old.csv | wc -l)" >> $GITHUB_ENV
        echo "cisaNewVAR=$(data/raw/cisa-kev.csv | wc -l)" >> $GITHUB_ENV
        echo "differenceVAR=$(( $cisaOldVAR - $cisaNewVAR ))" >> $GITHUB_ENV
        rm data/raw/cisa-kev-old.csv

    - name: Fetch CVEs from Nuclei
      run: |
        git clone https://github.com/projectdiscovery/nuclei-templates.git
        find . -type f -name '*CVE-*' -exec basename {} \; > data/lists/NucleiList.txt
        sed -i 's/.yaml//g' data/lists/NucleiList.txt
        sort -u data/lists/NucleiList.txt -o data/lists/NucleiList.txt


    - name: Check for Nuclei and CISA KEV matches
      run: |
           grep -wof data/lists/NucleiList.txt data/raw/cisa-kev.csv | sort | uniq > data/lists/CISA-Scannable-List.txt


    - name: Fetch PoC data from ProjectDiscovery API
      # Only run PoC collection on Sundays (weekly update)
      if: github.event.schedule == '0 3 * * 0' || github.event_name == 'workflow_dispatch'
      run: |
           echo "üîç Fetching PoC availability data from ProjectDiscovery API (weekly update)..."
           python scripts/fetch_poc_data.py || echo "‚ö†Ô∏è  PoC data fetch failed, continuing without PoC data"

    - name: Declare VARs
      run: |
           echo "totalVAR=$(($(wc -l < data/raw/cisa-kev.csv) - 1))" >> $GITHUB_ENV
           echo "nucleiVAR=$(wc -l < data/lists/CISA-Scannable-List.txt)" >> $GITHUB_ENV
           if [ -f data/lists/CISA-POC-List.txt ]; then
             echo "pocVAR=$(wc -l < data/lists/CISA-POC-List.txt)" >> $GITHUB_ENV
           else
             echo "pocVAR=0" >> $GITHUB_ENV
           fi
           
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pandas matplotlib seaborn numpy requests
    
    - name: Generate comprehensive statistics
      run: |
        python scripts/generate_stats.py > /tmp/new_stats.md
    
    - name: Update README with new statistics
      run: |
        # Extract everything before the stats section
        sed -n '1,/## üìä Database Statistics/p' README.md | head -n -1 > /tmp/readme_before.md
        
        # Extract everything after the stats section (from "---" after stats to end)
        sed -n '/^\*Statistics last updated:/,$ p' README.md | tail -n +2 > /tmp/readme_after.md
        
        # Combine: before + new stats + after
        cat /tmp/readme_before.md > README.md
        cat /tmp/new_stats.md >> README.md
        echo "" >> README.md
        echo "---" >> README.md
        cat /tmp/readme_after.md >> README.md

    - name: VAR Output Validation
      run: |
         echo "Total Vulnerabilities: ${{ env.totalVAR }}"
         echo "New vulnerabilities added: ${{ env.differenceVAR }}"
         echo "CISA Scannable list: ${{ env.nucleiVAR }}"
         echo "CVEs with public PoCs: ${{ env.pocVAR }}"

    - name: Slack Notification
      if: env.differenceVAR > 0
      uses: slackapi/slack-github-action@v1.23.0
      with:
          payload: |
           {
            "text": "üìà *CISA's KEV has been updated!*\n\n New vulnerabilities added: `${{ env.differenceVAR }}`\nTotal Vulnerabilities: `${{ env.totalVAR }}`\nCISA Scannable list: `${{ env.nucleiVAR }}`\nüí£ With public PoCs: `${{ env.pocVAR }}`",
            "blocks": [
             {
               "type": "section",
                "text": {
                  "type": "mrkdwn",
                 "text": "üìà *CISA's KEV has been updated!*\n\n New vulnerabilities added: `${{ env.differenceVAR }}`\nTotal Vulnerabilities: `${{ env.totalVAR }}`\nCISA Scannable list: `${{ env.nucleiVAR }}`\nüí£ With public PoCs: `${{ env.pocVAR }}`"
                }
             }
            ]
            }

    - name: Commit changes
      run: |
          git config --local user.email "hakrish@pm.me"
          git config --local user.name "rxerium"
          git add .
          git commit -m "CISA KEV Updates" -a || true
          git push
